<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Concepts</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Concepts</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#logical_services_and_backends">Logical services and backends</a></li>
<li><a href="#resolvers">Resolvers</a></li>
<li><a href="#connections">Connections</a></li>
<li><a href="#connection_pools_and_sets">Connection pools and sets</a></li>
<li><a href="#further_information">Further information</a></li>
<li><a href="#api">API</a>
<ul class="sectlevel1">
<li><a href="#agent">1. HttpAgent, HttpsAgent</a>
<ul class="sectlevel2">
<li><a href="#new_httpagentoptions">1.1. <code>new HttpAgent(options)</code></a></li>
<li><a href="#new_httpsagentoptions">1.2. <code>new HttpsAgent(options)</code></a></li>
<li><a href="#stopcb">1.3. <code>#stop([cb])</code></a></li>
<li><a href="#isstopped">1.4. <code>#isStopped()</code></a></li>
<li><a href="#getpoolhost">1.5. <code>#getPool([host])</code></a></li>
<li><a href="#createpoolhost_options">1.6. <code>#createPool(host, [options])</code></a></li>
</ul>
</li>
<li><a href="#pool">2. ConnectionPool</a>
<ul class="sectlevel2">
<li><a href="#state_transitions">2.1. State transitions</a></li>
<li><a href="#new-pool">2.2. <code>new ConnectionPool(options)</code></a></li>
<li><a href="#stop">2.3. <code>#stop()</code></a></li>
<li><a href="#claimoptions_callback">2.4. <code>#claim([options, ]callback)</code></a></li>
<li><a href="#getlasterror">2.5. <code>#getLastError()</code></a></li>
<li><a href="#getstats">2.6. <code>#getStats()</code></a></li>
</ul>
</li>
<li><a href="#resolver">3. Resolver</a>
<ul class="sectlevel2">
<li><a href="#about_the_interface">3.1. About the interface</a></li>
<li><a href="#start">3.2. <code>#start()</code></a></li>
<li><a href="#stop_2">3.3. <code>#stop()</code></a></li>
<li><a href="#getlasterror_2">3.4. <code>#getLastError()</code></a></li>
<li><a href="#getstate">3.5. <code>#getState()</code></a></li>
<li><a href="#isinstatestate">3.6. <code>#isInState(state)</code></a></li>
<li><a href="#statechangedstate">3.7. <code>&#8594;stateChanged(state)</code></a></li>
<li><a href="#addedkey_backend">3.8. <code>&#8594;added(key, backend)</code></a></li>
<li><a href="#removedkey">3.9. <code>&#8594;removed(key)</code></a></li>
</ul>
</li>
<li><a href="#dns_based_name_resolver">4. DNS-based name resolver</a>
<ul class="sectlevel2">
<li><a href="#new_dnsresolveroptions">4.1. <code>new DNSResolver(options)</code></a></li>
</ul>
</li>
<li><a href="#static_ip_resolver">5. Static IP resolver</a>
<ul class="sectlevel2">
<li><a href="#new_staticipresolveroptions">5.1. <code>new StaticIpResolver(options)</code></a></li>
</ul>
</li>
<li><a href="#picking_the_right_resolver">6. Picking the right resolver</a>
<ul class="sectlevel2">
<li><a href="#resolverforipordomainoptions">6.1. <code>resolverForIpOrDomain(options)</code></a></li>
</ul>
</li>
<li><a href="#connection_interface">7. Connection interface</a>
<ul class="sectlevel2">
<li><a href="#constructorbackend">7.1. <code>constructor(backend)</code></a></li>
<li><a href="#connect_required">7.2. <code>&#8594;connect()</code> (required)</a></li>
<li><a href="#close_required">7.3. <code>&#8594;close()</code> (required)</a></li>
<li><a href="#destroy_required">7.4. <code>#destroy()</code> (required)</a></li>
<li><a href="#errorerrobj">7.5. <code>&#8594;error(errObj)</code></a></li>
<li><a href="#timeout">7.6. <code>&#8594;timeout()</code></a></li>
<li><a href="#setunwanted">7.7. <code>&#8594;setUnwanted()</code></a></li>
</ul>
</li>
<li><a href="#errors">8. Errors</a>
<ul class="sectlevel2">
<li><a href="#claimtimeouterror">8.1. <code>ClaimTimeoutError</code></a></li>
<li><a href="#nobackendserror">8.2. <code>NoBackendsError</code></a></li>
</ul>
</li>
<li><a href="#kang_support">9. Kang support</a>
<ul class="sectlevel2">
<li><a href="#poolmonitor_tokangoptions">9.1. <code>poolMonitor.toKangOptions()</code></a></li>
</ul>
</li>
<li><a href="#recovery_objects">10. Recovery objects</a></li>
<li><a href="#dynamic_resolver_mode">11. Dynamic Resolver mode</a>
<ul class="sectlevel2">
<li><a href="#example">11.1. Example</a></li>
</ul>
</li>
<li><a href="#connectionset">12. ConnectionSet</a>
<ul class="sectlevel2">
<li><a href="#new_connectionsetoptions">12.1. <code>new ConnectionSet(options)</code></a></li>
<li><a href="#addedkey_connection_handle">12.2. <code>&#8594;added(key, connection, handle)</code></a></li>
<li><a href="#removedkey_2">12.3. <code>&#8594;removed(key)</code></a></li>
<li><a href="#stop_3">12.4. <code>#stop()</code></a></li>
<li><a href="#settargettarget">12.5. <code>#setTarget(target)</code></a></li>
<li><a href="#getconnections">12.6. <code>#getConnections()</code></a></li>
<li><a href="#getlasterror_3">12.7. <code>#getLastError()</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#tools">Tools</a>
<ul class="sectlevel1">
<li><a href="#cbresolve">13. cbresolve</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="logical_services_and_backends">Logical services and backends</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Many parts of <code>cueball</code> deal with the concept of a "logical service". This is
a uniquely named entity (usually a DNS name) that is used to refer to a
service offered to the network by potentially many processes running on many
machines.</p>
</div>
<div class="paragraph">
<p>For example, <code>(_dns._udp.)binder.staging-1.joyent.us</code> is a logical service that
provides DNS (over UDP), under the unique name <code>binder.staging-1.joyent.us</code>.
There may be only one physical machine providing this logical service, or there
may be many, and on each physical machine there may be multiple processes
providing it, or just one.</p>
</div>
<div class="paragraph">
<p>Each process on each machine that provides the service is referred to as a
"backend" for that logical service. A backend is uniquely identified within
a given logical service by the tuple of network (IP) <code>address</code> and <code>port</code>.</p>
</div>
<div class="paragraph">
<p>Note that for a group of backends to be part of the same logical service, it
should be completely equivalent to connect to one of them as any other (i.e.
there must be no requirement from the application to connect to some specific
individual backend at any time).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="resolvers">Resolvers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A "resolver" is the name we give to a component responsible for locating all of
the backends available within a logical service, obtaining their IP address and
port information (or whatever is required to connect to them) and tracking them.
This is normally a service discovery client of some form&#8201;&#8212;&#8201;e.g. <code>cueball</code>
provides a default DNS-based Resolver which uses DNS SRV records as a form of
service discovery mechanism to find backends.</p>
</div>
<div class="paragraph">
<p>You can plug your own Resolver implementation into <code>cueball</code> to provide this
mechanism, however, as long as it can track changes in the set of backends in a
timely manner (it is expected to emit events only on changes, rather than
periodic polling or refreshes).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="connections">Connections</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In <code>cueball</code>, a "connection" is not necessarily just a TCP socket. It can be
any EventEmitter that provides some kind of logical connection to a given
backend, as long as it obeys a similar interface to a socket.</p>
</div>
<div class="paragraph">
<p>This is intended to allow users of the API to represent a "connection" as an
application or session layer concept. For example, it could be useful to
construct a pool of connections to an LDAP server that perform a bind
operation (authenticate) before they are considered "connected".</p>
</div>
<div class="paragraph">
<p>The user of the <code>cueball</code> API passes in a "constructor" function which, when
called, must return a new connection object that has begun an attempt to
connect. More details about this are included further into the API
documentation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="connection_pools_and_sets">Connection pools and sets</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The principal active components of <code>cueball</code> are connection Pools, and Sets.</p>
</div>
<div class="paragraph">
<p>A connection Pool is a set of connections maintained to any subset of available
backends for one single logical service. The connections are handed out to users
of the pool in a temporary lease, then later returned to the pool for re-use.
A single connection is never given out concurrently to more than one user of
the pool. This paradigm is ideal for many common protocols such as HTTP, LDAP,
database connections etc.</p>
</div>
<div class="paragraph">
<p>A connection Set is the same concept as a connection Pool, but with the ability
for a single connection to be used by more than one user at the same time. It
is designed for use with services that multiplex operations onto a single socket
or which are not as strictly connection-oriented and ordered.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="further_information">Further information</h2>
<div class="sectionbody">
<div class="paragraph">
<p>More detailed exploration of these concepts and the design of <code>cueball</code> can be
found in the <a href="./internals.html">Cueball internals</a> document.</p>
</div>
</div>
</div>
<h1 id="api" class="sect0">API</h1>
<div class="sect1">
<h2 id="agent">1. HttpAgent, HttpsAgent</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="new_httpagentoptions">1.1. <code>new HttpAgent(options)</code></h3>

</div>
<div class="sect2">
<h3 id="new_httpsagentoptions">1.2. <code>new HttpsAgent(options)</code></h3>
<div class="paragraph">
<p>Creates an HTTP(S) agent that can be used with the node <code>http</code> client API. The
agent implicitly creates a ConnectionPool for each new hostname it encounters
when processing requests.</p>
</div>
<div class="paragraph">
<p>You can either pre-populate the set of pools by giving the <code>initialDomains</code>
option, or simply make requests and the pools will be constructed at the first
request for each host.</p>
</div>
<div class="paragraph">
<p>Parameters</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>options</code>&#8201;&#8212;&#8201;Object, with keys:</p>
<div class="ulist">
<ul>
<li>
<p><code>recovery</code>&#8201;&#8212;&#8201;Object, a recovery spec (see below)</p>
</li>
<li>
<p><code>spares</code>&#8201;&#8212;&#8201;Number, number of spares wanted in the pool per host</p>
</li>
<li>
<p><code>maximum</code>&#8201;&#8212;&#8201;Number, maximum number of connections per host</p>
</li>
<li>
<p><code>resolvers</code>&#8201;&#8212;&#8201;optional Array of String, either containing IP addresses to
use as nameservers, or a single string for Dynamic Resolver mode</p>
</li>
<li>
<p><code>log</code>&#8201;&#8212;&#8201;optional Object, a <code>bunyan</code>-style logger to use</p>
</li>
<li>
<p><code>initialDomains</code>&#8201;&#8212;&#8201;optional Array of String, initial domains to create
connections to at startup (to pre-seed the Agent for quick use later)</p>
</li>
<li>
<p><code>defaultPort</code>&#8201;&#8212;&#8201;optional Number, fallback TCP port to connect to (default
80 for HttpAgent, 443 for HttpsAgent). If SRV records for a name are found
the port from SRV will always be used instead of this.</p>
</li>
<li>
<p><code>tcpKeepAliveInitialDelay</code>&#8201;&#8212;&#8201;optional Number, if supplied, enable TCP
level keep-alives with the given initial delay (in milliseconds)</p>
</li>
<li>
<p><code>ping</code>&#8201;&#8212;&#8201;optional String, URL path to use for health checking. Connection
is considered still viable if this URL returns a non-5xx response code.</p>
</li>
<li>
<p><code>pingInterval</code>&#8201;&#8212;&#8201;optional Number, interval between health check pings</p>
</li>
<li>
<p><code>errorOnEmpty</code>&#8201;&#8212;&#8201;optional Boolean</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="stopcb">1.3. <code>#stop([cb])</code></h3>
<div class="paragraph">
<p>Stops the pools managed by this agent, calling <code>cb</code> (if given) once all have
stopped.</p>
</div>
<div class="paragraph">
<p>Once an Agent has been stopped, it can no longer accept any new requests, and
will throw an Error if asked to do so. Calling <code>stop()</code> more than once is
also an error and will throw.</p>
</div>
<div class="paragraph">
<p>Parameters</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cb</code>&#8201;&#8212;&#8201;optional Function (err)</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Any pools spun up by the Agent will continue to keep the process
open even if there are no outstanding requests (due to the spare connections
held by the pool). The <code>stop()</code> method should be used on an Agent if your
program does not plan to use it again and wishes to be able to exit node
without calling <code>process.exit()</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="isstopped">1.4. <code>#isStopped()</code></h3>
<div class="paragraph">
<p>Boolean, is this Agent stopped?. Useful to prevent exceptions being thrown
when calling <code>stop()</code> more than once.</p>
</div>
</div>
<div class="sect2">
<h3 id="getpoolhost">1.5. <code>#getPool([host])</code></h3>
<div class="paragraph">
<p>Returns the connection pool this agent has created for the input host. If no
pool has yet been created, returns <code>undefined</code>.</p>
</div>
<div class="paragraph">
<p>Parameters</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>host</code>&#8201;&#8212;&#8201;String, hostname of the host for which the pool is being requested.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="createpoolhost_options">1.6. <code>#createPool(host, [options])</code></h3>
<div class="paragraph">
<p>Creates and returns a connection pool for the host identified by the input host
name if one doesn&#8217;t already exist. You can either provide a resolver directly in
the options parameter or have one allocated by cueball (the behaviour matches
<code>resolverForIpOrDomain()</code>). If you provide a resolver, the Agent takes no
responsibility for calling its <code>start()</code> or <code>stop()</code> methods. The caller is
responsible for doing so.</p>
</div>
<div class="paragraph">
<p>Parameters</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>host</code>&#8201;&#8212;&#8201;String, hostname of the host for which a pool will be created.</p>
</li>
<li>
<p><code>options</code>&#8201;&#8212;&#8201;an optional Object, with keys:</p>
<div class="ulist">
<ul>
<li>
<p><code>resolver</code>&#8201;&#8212;&#8201;optional Object satisfying the Resolver interface, the
resolver to use for this pool. If given, <code>port</code> will be
ignored.</p>
</li>
<li>
<p><code>port</code>&#8201;&#8212;&#8201;optional Number, override the default port number used for
this pool (the Resolver can still override this).</p>
</li>
<li>
<p><code>rejectUnauthorized</code>, <code>pfx</code>, <code>key</code>, <code>passphrase</code>, <code>cert</code>, <code>ca</code>, <code>ciphers</code>,
<code>servername</code>&#8201;&#8212;&#8201;TLS options, passed through to the TLS library.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This function throws an error synchronously if a resolver for the
provided host already exists, or if the Agent is stopped.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="pool">2. ConnectionPool</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="state_transitions">2.1. State transitions</h3>
<div class="paragraph">
<p>ConnectionPool exposes the <code>mooremachine</code> FSM interface, with the following
state graph:</p>
</div>
<div class="listingblock">
<div class="title">"Example: " 1. ConnectionPool state transition diagram</div>
<div class="content">
<pre>                                                           | (from failed)
                                                .stop()    v
             +--------+   connect ok   +-------+       +--------+
    init --&gt; |starting| +------------&gt; |running| +---&gt; |stopping|
             +--------+                +-------+       +--------+
                 +                      ^     +            +
        resolver |                      |     |            |
          failed |                      |     |            |
              OR |       +------+       |     |            v
         retries +----&gt;  |failed| +-----+     |        +-------+
       exhausted         +------+ connect ok  |        |stopped|
                          +  ^                |        +-------+
                          |  |                |
                   .stop()|  +----------------+
                          |   all retries exhausted</pre>
</div>
</div>
<div class="paragraph">
<p>Pools begin their life in the "starting" state. Once they have successfully made
one connection to any backend, they proceed to the "running" state. Otherwise,
if their underlying Resolver enters the "failed" state, or they exhaust their
retry policy attempting to connect to all their backends, they enter the
"failed" state. Here they keep trying to connect to valid backends at their
maximum backoff values, so as to be able to detect if a backend recovers.</p>
</div>
<div class="paragraph">
<p>A "running" pool can then either be stopped by calling the <code>.stop()</code> method, at
which point it enters the "stopping" state and begins tearing down its
connections; or all of its connections become disconnected and it exhausts its
retry policy, in which case it enters the "failed" state.</p>
</div>
<div class="paragraph">
<p>Failed pools can re-enter the "running" state at any time if they make a
successful connection to a backend and their underlying Resolver is no longer
"failed". A "failed" pool can also have the <code>.stop()</code> method called, in which
case it proceeds much as from "running".</p>
</div>
</div>
<div class="sect2">
<h3 id="new-pool">2.2. <code>new ConnectionPool(options)</code></h3>
<div class="paragraph">
<p>Creates a new pool of connections.  There are two ways of using a
ConnectionPool.  You can either provide your own resolver directly, or provide
parameters with which to create the default, DNS-based resolver.</p>
</div>
<div class="paragraph">
<p>Parameters</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>options</code>&#8201;&#8212;&#8201;Object, with keys:</p>
<div class="ulist">
<ul>
<li>
<p><code>constructor</code>&#8201;&#8212;&#8201;Function(backend) &#8594; object, must open a new connection
to the given backend and return it</p>
</li>
<li>
<p><code>domain</code>&#8201;&#8212;&#8201;String, name to look up to find backends.</p>
</li>
<li>
<p><code>recovery</code>&#8201;&#8212;&#8201;Object, a recovery spec (see below)</p>
</li>
<li>
<p><code>spares</code>&#8201;&#8212;&#8201;Number, number of spares wanted in the pool per host</p>
</li>
<li>
<p><code>maximum</code>&#8201;&#8212;&#8201;Number, maximum number of connections per host</p>
</li>
<li>
<p><code>service</code>&#8201;&#8212;&#8201;optional String, name of SRV service (e.g. <code>_http._tcp</code>)</p>
</li>
<li>
<p><code>defaultPort</code>&#8201;&#8212;&#8201;optional Number, port to use for plain A/AAAA records</p>
</li>
<li>
<p><code>resolvers</code>&#8201;&#8212;&#8201;optional Array of String, either containing IP addresses to
use as nameservers, or a single string for Dynamic Resolver mode (default
uses system resolvers from <code>/etc/resolv.conf</code>)</p>
</li>
<li>
<p><code>log</code>&#8201;&#8212;&#8201;optional Object, a <code>bunyan</code>-style logger to use</p>
</li>
<li>
<p><code>maxDNSConcurrency</code>&#8201;&#8212;&#8201;optional Number, max number of DNS queries to issue
at once (default 5)</p>
</li>
<li>
<p><code>checkTimeout</code>&#8201;&#8212;&#8201;optional Number, milliseconds of idle time before
running <code>checker</code> on a connection</p>
</li>
<li>
<p><code>checker</code>&#8201;&#8212;&#8201;optional Function(handle, connection), to be run on idle
connections</p>
</li>
<li>
<p><code>targetClaimDelay</code>&#8201;&#8212;&#8201;optional Number, a target time for latency to claim
accept/timeout, done through Adaptive Queue Management</p>
</li>
<li>
<p><code>decoherenceInterval</code>&#8201;&#8212;&#8201;optional Number, seconds between re-shuffles of
the backend preference list to try to avoid "coherence" between multiple
clients (see the Cueball Internals document for more information). Minimum
value of 60 (smaller values will be clamped to 60 seconds).</p>
</li>
<li>
<p><code>resolver</code>&#8201;&#8212;&#8201;optional instance of an object meeting the Resolver interface
below.  You would typically obtain this object by either creating your own
Resolver directly or using the <code>resolverForIpOrDomain</code> function.</p>
</li>
<li>
<p><code>maxChurnRate</code>&#8201;&#8212;&#8201;optional Number, maximum rate in connections per second
to limit connection churn to on a per-backend basis. If set, cueball will
never create or destroy connections to a given backend at a higher rate
than the one given.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Do not confuse <code>resolvers</code> (the list of IP addresses for the DNS resolvers to
contact) with <code>resolver</code> (a custom object meeting the Resolver interface below).</p>
</div>
<div class="paragraph">
<p>If you want to use a custom resolver, then you must specify the <code>resolver</code>
property.  In that case, the <code>resolvers</code>, <code>maxDNSConcurrency</code>, <code>defaultPort</code>,
and <code>recovery</code> options are ignored, and the <code>domain</code> and <code>service</code> properties
are used only for logging.</p>
</div>
<div class="paragraph">
<p>Otherwise, if want to use the default DNS-based resolver, do not specify the
<code>resolver</code> property.  A resolver instance will be created based on the other
configuration properties.</p>
</div>
</div>
<div class="sect2">
<h3 id="stop">2.3. <code>#stop()</code></h3>
<div class="paragraph">
<p>Stops the connection pool and its <code>Resolver</code>, then destroys all connections.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Any pool running in a process will continue to keep the process
open even if there are no outstanding claims or activity (due to the spare
connections held by the pool). The <code>stop()</code> method is the correct way to
allow the process to exit if there is no more work to be done using the Pool.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="claimoptions_callback">2.4. <code>#claim([options, ]callback)</code></h3>
<div class="paragraph">
<p>Claims a connection from the pool ready for use.</p>
</div>
<div class="paragraph">
<p>Parameters</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>options</code>&#8201;&#8212;&#8201;optional Object, with keys:</p>
<div class="ulist">
<ul>
<li>
<p><code>timeout</code>&#8201;&#8212;&#8201;optional Number, timeout for request in ms
(default <code>Infinity</code>)</p>
</li>
<li>
<p><code>errorOnEmpty</code>&#8201;&#8212;&#8201;optional Boolean, if true return error straight away
if the pool has no backends at all (i.e., nothing was found in DNS)</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>callback</code>&#8201;&#8212;&#8201;Function(err[, handle, connection]), parameters:</p>
<div class="ulist">
<ul>
<li>
<p><code>err</code>&#8201;&#8212;&#8201;an Error object, if the request could not be fulfilled or timed
out</p>
</li>
<li>
<p><code>handle</code>&#8201;&#8212;&#8201;Object, handle to be used to release the connection back to
the pool when work is complete</p>
</li>
<li>
<p><code>connection</code>&#8201;&#8212;&#8201;Object, the actual connection (as returned by the
<code>constructor</code> given to <code>new ConnectionPool()</code>)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Returns a "waiter handle", which is an Object having a <code>cancel()</code> method. The
<code>cancel()</code> method may be called at any time up to when the <code>callback</code> is run, to
cancel the request to the pool and relinquish any queue positions held.</p>
</div>
<div class="paragraph">
<p>When a client is done with a connection, they must call <code>handle.release()</code> to
return it to the pool. All event handlers should be disconnected from the
<code>connection</code> prior to calling <code>release()</code>.</p>
</div>
<div class="paragraph">
<p>If a client determines that a connection must be closed immediately (e.g. due
to a protocol error making it impossible to continue using it safely), it must
call the <code>.close()</code> method on the <strong>handle</strong>, not any <code>.destroy()</code> or similar
method on the connection itself.</p>
</div>
<div class="paragraph">
<p>Calling <code>claim()</code> on a Pool that is in the "stopping", "stopped" or "failed"
states will result in the callback being called with an error on the next run of
the event loop.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>connection</code> object given to you in the callback for <code>claim()</code> may
emit <code>'error'</code>. If you do not register a handler for this event immediately
at the start of your claim, and it emits, this will be treated as an uncaught
error and cause the program to crash.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="getlasterror">2.5. <code>#getLastError()</code></h3>
<div class="paragraph">
<p>When the pool has entered state "failed", this method may be used to retrieve
the last Error object emitted by a connection attempt in the pool. Note that
while this is very likely to be a proximate cause of the pool failure,
determining the root cause may require further analysis.</p>
</div>
<div class="paragraph">
<p>Returns an Error object.</p>
</div>
</div>
<div class="sect2">
<h3 id="getstats">2.6. <code>#getStats()</code></h3>
<div class="paragraph">
<p>Returns an object containing a snapshot of the current counters, along with
with four additional numbers: total connections, idle connections, partly-open
connections, and the number of requests queued waiting.</p>
</div>
<div class="listingblock">
<div class="title">Example: An object returned by #getStats()</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span></span><span class="tok-p">{</span> <span class="tok-nx">counters</span><span class="tok-o">:</span>
   <span class="tok-p">{</span> <span class="tok-nx">claim</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
     <span class="tok-s1">&#39;max-claim-queue&#39;</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
     <span class="tok-s1">&#39;queued-claim&#39;</span><span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">},</span>
  <span class="tok-nx">totalConnections</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-nx">idleConnections</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-nx">pendingConnections</span><span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
  <span class="tok-nx">waiterCount</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="resolver">3. Resolver</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="about_the_interface">3.1. About the interface</h3>
<div class="paragraph">
<p>An interface for all "resolvers", objects which take in some kind of
configuration (e.g. a DNS name) and track a list of "backends" for that
name. A "backend" is an IP/port pair that describes an endpoint that can
be connected to to reach a given service.</p>
</div>
<div class="paragraph">
<p>Resolver exposes the <code>mooremachine</code> FSM interface, with the following state
graph:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>                .start()          error
        +-------+       +--------+       +------+
init -&gt; |stopped| +---&gt; |starting| +---&gt; |failed|
        +---+---+       +---+----+       +------+
            ^               |               +
            |               | ok            |
            |               v               |
        +---+----+      +---+---+           |
        |stopping| &lt;--+ |running|  &lt;--------+
        +--------+      +-------+       retry success
                 .stop()</pre>
</div>
</div>
<div class="paragraph">
<p>Resolvers begin their life "stopped". When the user calls <code>.start()</code>, they
begin the process of resolving the name/configuration they were given into
backends.</p>
</div>
<div class="paragraph">
<p>If the initial attempt to resolve the name/configuration fails, the Resolver
enters the "failed" state, but continues retrying. If it succeeds, or if any
later retry succeeds, it moves to the "running" state. The reason why the
"failed" state exists is so that commandline tools and other short-lived
processes can make use of it to decide when to "give up" on a name resolution.</p>
</div>
<div class="paragraph">
<p>Once an attempt has succeeded, the Resolver will begin emitting <code>added</code> and
<code>removed</code> events (see below) describing the backends that it has found.</p>
</div>
<div class="paragraph">
<p>In the "running" state, the Resolver continues to monitor the source of its
backends (e.g. in DNS by retrying once the TTL expires) and emitting these
events when changes occur.</p>
</div>
<div class="paragraph">
<p>Finally, when the <code>.stop()</code> method is called, the Resolver transitions to
"stopping", stops monitoring and emitting events, and comes to rest in the
"stopped" state where it started.</p>
</div>
</div>
<div class="sect2">
<h3 id="start">3.2. <code>#start()</code></h3>
<div class="paragraph">
<p>Starts the resolver&#8217;s normal operation (by beginning the process of looking up
the names given).</p>
</div>
</div>
<div class="sect2">
<h3 id="stop_2">3.3. <code>#stop()</code></h3>
<div class="paragraph">
<p>Stops the resolver. No further events will be emitted unless <code>start()</code> is
called again.</p>
</div>
</div>
<div class="sect2">
<h3 id="getlasterror_2">3.4. <code>#getLastError()</code></h3>
<div class="paragraph">
<p>Returns the last error experienced by the Resolver. This is particularly useful
when the Resolver is in the "failed" state, to produce a log message or user
interface text.</p>
</div>
</div>
<div class="sect2">
<h3 id="getstate">3.5. <code>#getState()</code></h3>
<div class="paragraph">
<p>Returns the current state of the Resolver as a string (see diagram above).</p>
</div>
<div class="paragraph">
<p>Inherited from <code>mooremachine.FSM</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="isinstatestate">3.6. <code>#isInState(state)</code></h3>
<div class="paragraph">
<p>Returns true if <code>state</code> matches the current state of the Resolver
(see diagram above).</p>
</div>
<div class="paragraph">
<p>Inherited from <code>mooremachine.FSM</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="statechangedstate">3.7. <code>&#8594;stateChanged(state)</code></h3>
<div class="paragraph">
<p>An event that fires whenever the Resolver changes state.</p>
</div>
<div class="paragraph">
<p>Inherited from <code>mooremachine.FSM</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="addedkey_backend">3.8. <code>&#8594;added(key, backend)</code></h3>
<div class="paragraph">
<p>Emitted when a new backend has been found.</p>
</div>
<div class="paragraph">
<p>Parameters</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>key</code>&#8201;&#8212;&#8201;String, a unique key for this backend (will be referenced by any
subsequent events about this backend)</p>
</li>
<li>
<p><code>backend</code>&#8201;&#8212;&#8201;Object, with keys:</p>
<div class="ulist">
<ul>
<li>
<p><code>name</code>&#8201;&#8212;&#8201;String, the DNS name for this backend</p>
</li>
<li>
<p><code>address</code>&#8201;&#8212;&#8201;String, an IPv4 or IPv6 address</p>
</li>
<li>
<p><code>port</code>&#8201;&#8212;&#8201;Number</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="removedkey">3.9. <code>&#8594;removed(key)</code></h3>
<div class="paragraph">
<p>Emitted when an existing backend has been removed.</p>
</div>
<div class="paragraph">
<p>Parameters</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>key</code>&#8201;&#8212;&#8201;String, unique key for this backend</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="dns_based_name_resolver">4. DNS-based name resolver</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="new_dnsresolveroptions">4.1. <code>new DNSResolver(options)</code></h3>
<div class="paragraph">
<p>Creates a Resolver that looks up a name in DNS. This Resolver prefers SRV
records if they are available, and falls back to A/AAAA records if they cannot
be found.</p>
</div>
<div class="paragraph">
<p>Parameters</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>options</code>&#8201;&#8212;&#8201;Object, with keys:</p>
<div class="ulist">
<ul>
<li>
<p><code>domain</code>&#8201;&#8212;&#8201;String, name to look up to find backends</p>
</li>
<li>
<p><code>recovery</code>&#8201;&#8212;&#8201;Object, a recovery spec (see below)</p>
</li>
<li>
<p><code>service</code>&#8201;&#8212;&#8201;optional String, name of SRV service (e.g. <code>_http._tcp</code>)</p>
</li>
<li>
<p><code>defaultPort</code>&#8201;&#8212;&#8201;optional Number, port to use for plain A/AAAA records</p>
</li>
<li>
<p><code>resolvers</code>&#8201;&#8212;&#8201;optional Array of String, either containing IP addresses to
use as nameservers, or a single string for Dynamic Resolver mode (default
uses system resolvers from <code>/etc/resolv.conf</code>)</p>
</li>
<li>
<p><code>log</code>&#8201;&#8212;&#8201;optional Object, a <code>bunyan</code>-style logger to use</p>
</li>
<li>
<p><code>maxDNSConcurrency</code>&#8201;&#8212;&#8201;optional Number, max number of DNS queries to issue
at once (default 5)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="static_ip_resolver">5. Static IP resolver</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="new_staticipresolveroptions">5.1. <code>new StaticIpResolver(options)</code></h3>
<div class="paragraph">
<p>Creates a new static IP resolver.  This object matches the Resolver interface
above, but emits a fixed list of IP addresses when started.  This list never
changes.  This is intended for development environments and debugging tools,
where a user may have provided an explicit IP address rather than a DNS name to
contact.  See also: <code>resolverForIpOrDomain()</code>.</p>
</div>
<div class="paragraph">
<p>Parameters</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>options</code>&#8201;&#8212;&#8201;Object, with keys:</p>
<div class="ulist">
<ul>
<li>
<p><code>defaultPort</code>&#8201;&#8212;&#8201;optional Number, fallback port to use for backends
that only have an <code>address</code> property</p>
</li>
<li>
<p><code>backends</code>&#8201;&#8212;&#8201;Array of objects, each having properties:</p>
<div class="ulist">
<ul>
<li>
<p><code>address</code>&#8201;&#8212;&#8201;String, an IP address to emit as a backend</p>
</li>
<li>
<p><code>port</code>&#8201;&#8212;&#8201;Number (optional if <code>defaultPort</code> used), a port number
for this backend</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>This object provides the same <code>start()</code> and <code>stop()</code> methods as the Resolver
class, as well as the same <code>added</code> and <code>removed</code> events.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="picking_the_right_resolver">6. Picking the right resolver</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="resolverforipordomainoptions">6.1. <code>resolverForIpOrDomain(options)</code></h3>
<div class="paragraph">
<p>Services that use DNS for service discovery would typically use a DNS-based
resolver.  But in development environments or with debugging tools, it&#8217;s useful
to be able to point a cueball-using program at an instance located at a specific
IP address and port.  That&#8217;s what the Static IP resolver is for.</p>
</div>
<div class="paragraph">
<p>To make this easy for programs that want to support connecting to either
hostnames or IP addresses, this function is provided to take a configuration
(expected to come from a user, via an environment variable, command-line
option, or other configuration source), determine whether an IP address or DNS
name was specified, and return either a DNS-based or static resolver.  If the
input appears to be neither a valid IPv4 nor IPv6 address nor DNS name, or the
port number is not valid, then an Error is returned (not thrown).  (If the
input is missing or has the wrong type, an Error object is thrown, since this
is a programmer error.)</p>
</div>
<div class="paragraph">
<p>Parameters</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>options</code>&#8201;&#8212;&#8201;Object, with keys:</p>
<div class="ulist">
<ul>
<li>
<p><code>input</code>&#8201;&#8212;&#8201;String, either an IP address or DNS name, with optional port
suffix</p>
</li>
<li>
<p><code>resolverConfig</code>&#8201;&#8212;&#8201;Object, a set of additional properties to pass to
the resolver constructor, with keys:</p>
<div class="ulist">
<ul>
<li>
<p><code>defaultPort</code>&#8201;&#8212;&#8201;optional Number, used for both DNS and static names</p>
</li>
<li>
<p><code>recovery</code>&#8201;&#8212;&#8201;Object, see <code>DNSResolver</code>, required for DNS lookups</p>
</li>
<li>
<p><code>service</code>&#8201;&#8212;&#8201;optional String, see <code>DNSResolver</code></p>
</li>
<li>
<p><code>resolvers</code>&#8201;&#8212;&#8201;optional Array of String, see <code>DNSResolver</code></p>
</li>
<li>
<p><code>log</code>&#8201;&#8212;&#8201;optional Object, a <code>bunyan</code>-style logger to use</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>input</code> string has the form <code>HOSTNAME[:PORT]</code>, where the <code>[:PORT]</code> suffix is
optional, and <code>HOSTNAME</code> may be either an IP address or DNS name.</p>
</div>
<div class="listingblock">
<div class="title">Example: Creating a resolver that will emit one backend for an instance at IP 127.0.0.1 port 2020</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span></span><span class="tok-kd">var</span> <span class="tok-nx">resolver</span> <span class="tok-o">=</span> <span class="tok-nx">mod_cueball</span><span class="tok-p">.</span><span class="tok-nx">resolverForIpOrDomain</span><span class="tok-p">({</span>
    <span class="tok-s1">&#39;input&#39;</span><span class="tok-o">:</span> <span class="tok-s1">&#39;127.0.0.1:2020&#39;</span><span class="tok-p">,</span>
    <span class="tok-s1">&#39;resolverConfig&#39;</span><span class="tok-o">:</span> <span class="tok-p">{</span>
        <span class="tok-s1">&#39;recovery&#39;</span><span class="tok-o">:</span> <span class="tok-p">{</span>
            <span class="tok-s1">&#39;default&#39;</span><span class="tok-o">:</span> <span class="tok-p">{</span>
                <span class="tok-s1">&#39;retries&#39;</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
                <span class="tok-s1">&#39;timeout&#39;</span><span class="tok-o">:</span> <span class="tok-mi">1000</span><span class="tok-p">,</span>
                <span class="tok-s1">&#39;delay&#39;</span><span class="tok-o">:</span> <span class="tok-mi">1000</span><span class="tok-p">,</span>
                <span class="tok-s1">&#39;maxDelay&#39;</span><span class="tok-o">:</span> <span class="tok-mi">1000</span>
            <span class="tok-p">}</span>
        <span class="tok-p">}</span>
    <span class="tok-p">}</span>
<span class="tok-p">})</span>
<span class="tok-cm">/* check whether resolver is an Error */</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example: Creating a resolver that will track instances associated with DNS name <code>mydomain.example.com</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span></span><span class="tok-kd">var</span> <span class="tok-nx">resolver</span> <span class="tok-o">=</span> <span class="tok-nx">mod_cueball</span><span class="tok-p">.</span><span class="tok-nx">resolverForIpOrDomain</span><span class="tok-p">({</span>
    <span class="tok-s1">&#39;input&#39;</span><span class="tok-o">:</span> <span class="tok-s1">&#39;mydomain.example.com&#39;</span><span class="tok-p">,</span>
    <span class="tok-s1">&#39;resolverConfig&#39;</span><span class="tok-o">:</span> <span class="tok-p">{</span>
        <span class="tok-s1">&#39;recovery&#39;</span><span class="tok-o">:</span> <span class="tok-p">{</span>
            <span class="tok-s1">&#39;default&#39;</span><span class="tok-o">:</span> <span class="tok-p">{</span>
                <span class="tok-s1">&#39;retries&#39;</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
                <span class="tok-s1">&#39;timeout&#39;</span><span class="tok-o">:</span> <span class="tok-mi">1000</span><span class="tok-p">,</span>
                <span class="tok-s1">&#39;delay&#39;</span><span class="tok-o">:</span> <span class="tok-mi">1000</span><span class="tok-p">,</span>
                <span class="tok-s1">&#39;maxDelay&#39;</span><span class="tok-o">:</span> <span class="tok-mi">1000</span>
            <span class="tok-p">}</span>
        <span class="tok-p">}</span>
    <span class="tok-p">}</span>
<span class="tok-p">});</span>
<span class="tok-cm">/* check whether resolver is an Error */</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In these examples, the <code>input</code> string is assumed to come from a user
cueball does the expected thing when given an IP address or DNS name.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="connection_interface">7. Connection interface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Objects returned by a <code>constructor</code> function (such as supplied to the
<code>ConnectionPool</code> constructor) must obey a subset of the node.js socket
interface. In particular they must support the following events and methods:</p>
</div>
<div class="sect2">
<h3 id="constructorbackend">7.1. <code>constructor(backend)</code></h3>
<div class="paragraph">
<p>Parameters</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>backend</code>&#8201;&#8212;&#8201;an Object, with properties:</p>
</li>
<li>
<p><code>key</code>&#8201;&#8212;&#8201;a String, the backend key as supplied via the Resolver interface.
Can be used to uniquely identify the backend.</p>
</li>
<li>
<p><code>address</code>&#8201;&#8212;&#8201;a String, address of the backend (IPv4 or IPv6)</p>
</li>
<li>
<p><code>port</code>&#8201;&#8212;&#8201;a Number, TCP or UDP port number</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Returns an object obeying the Connection interface.</p>
</div>
</div>
<div class="sect2">
<h3 id="connect_required">7.2. <code>&#8594;connect()</code> (required)</h3>
<div class="paragraph">
<p>At construction, the connection object must immediately attempt to make a
connection to the backend specified by the first argument to the constructor.
When the connection succeeds, it must emit the event <code>connect</code>. No arguments are
required.</p>
</div>
</div>
<div class="sect2">
<h3 id="close_required">7.3. <code>&#8594;close()</code> (required)</h3>
<div class="paragraph">
<p>Connection objects must emit <code>close</code> as the final event they emit after the
connection has ended. No events may be emitted after <code>close</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="destroy_required">7.4. <code>#destroy()</code> (required)</h3>
<div class="paragraph">
<p>Immediately disconnects the connection and proceeds to emit <code>close</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="errorerrobj">7.5. <code>&#8594;error(errObj)</code></h3>
<div class="paragraph">
<p>Connection objects may emit <code>error</code> at any time in response to a fatal error.
The connection will be immediately terminated (by calling <code>.destroy()</code>) upon the
emission of any <code>error</code> event.</p>
</div>
<div class="paragraph">
<p>The <code>error</code> event should be emitted with an Object as the first parameter. This
is expected to have <code>Error</code> on its prototype chain (<code>obj instanceof Error</code>
should be <code>true</code>).</p>
</div>
<div class="paragraph">
<p>May also be emitted as <code>connectError</code> only in the state before <code>connect</code> has
been emitted.</p>
</div>
</div>
<div class="sect2">
<h3 id="timeout">7.6. <code>&#8594;timeout()</code></h3>
<div class="paragraph">
<p>Optional. Equivalent to emitting <code>error</code> with a ConnectionTimeoutError as an
argument.</p>
</div>
<div class="paragraph">
<p>May also be emitted as <code>connectTimeout</code> only in the state before <code>connect</code> has
been emitted.</p>
</div>
</div>
<div class="sect2">
<h3 id="setunwanted">7.7. <code>&#8594;setUnwanted()</code></h3>
<div class="paragraph">
<p>As an optional feature, connections that are still connecting to their assigned
backend may implement this function to detect that they have become "unwanted"
by cueball (e.g. because a primary backend as returned while they were starting
to connect). A connection that is unwanted will be closed immediately after
it has emitted its next event, regardless of whether the connection succeeds.</p>
</div>
<div class="paragraph">
<p>If your connection type has multiple phases of set-up before emitting <code>connect</code>
(e.g. an authentication step), this may be useful to avoid doing unnecessary
extra work in the case where the connection would be discarded anyway.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="errors">8. Errors</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="claimtimeouterror">8.1. <code>ClaimTimeoutError</code></h3>
<div class="paragraph">
<p>Passed as first argument to <code>ConnectionPool#claim()&#8217;s callback when the given
timeout in `options</code> has been exceeded.</p>
</div>
<div class="paragraph">
<p>Properties</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>pool</code>&#8201;&#8212;&#8201;ConnectionPool</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="nobackendserror">8.2. <code>NoBackendsError</code></h3>
<div class="paragraph">
<p>Passed as first argument to <code>ConnectionPool#claim()&#8217;s callback when there are
no known backends for the pool and the `errorOnEmpty</code> flag is set.</p>
</div>
<div class="paragraph">
<p>Properties</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>pool</code>&#8201;&#8212;&#8201;ConnectionPool</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kang_support">9. Kang support</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="poolmonitor_tokangoptions">9.1. <code>poolMonitor.toKangOptions()</code></h3>
<div class="paragraph">
<p>Returns an options object that can be passed to <code>mod_kang.knStartServer</code>. The
kang options set up snapshots containing a list of all <code>Pool</code> objects in the
system and their associated backends and state.</p>
</div>
<div class="paragraph">
<p>The returned object is missing the <code>port</code> property, which should be added
before using.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="recovery_objects">10. Recovery objects</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To specify the retry and timeout behaviour of Cueball DNS and pooled
connections, the "recovery spec object" is a required argument to most
constructors in the API.</p>
</div>
<div class="paragraph">
<p>A recovery spec object should always have at least one key, named <code>"default"</code>,
which gives the default settings for any operation.</p>
</div>
<div class="paragraph">
<p>More specific per-operation settings can also be given as additional keys.</p>
</div>
<div class="listingblock">
<div class="title">Example: A simple recovery object</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span></span><span class="tok-p">{</span>
  <span class="tok-k">default</span><span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-nx">timeout</span><span class="tok-o">:</span> <span class="tok-mi">2000</span><span class="tok-p">,</span>
    <span class="tok-nx">retries</span><span class="tok-o">:</span> <span class="tok-mi">3</span><span class="tok-p">,</span>
    <span class="tok-nx">delay</span><span class="tok-o">:</span> <span class="tok-mi">100</span>
  <span class="tok-p">},</span>
  <span class="tok-nx">dns</span><span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-nx">timeout</span><span class="tok-o">:</span> <span class="tok-mi">5000</span><span class="tok-p">,</span>
    <span class="tok-nx">retries</span><span class="tok-o">:</span> <span class="tok-mi">3</span><span class="tok-p">,</span>
    <span class="tok-nx">delay</span><span class="tok-o">:</span> <span class="tok-mi">200</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This specifies that DNS-related operations should have a timeout of 5 seconds,
3 retries, and an initial delay of 200ms, while all other operations (e.g.
<code>connect()</code> while connecting to a new backend) should have a timeout of 2
seconds, 3 retries and initial delay of 100ms.</p>
</div>
<div class="paragraph">
<p>The <code>delay</code> field indicates a time to wait between retry attempts. After each
failure, it will be doubled until it exceeds the value of <code>maxDelay</code>.</p>
</div>
<div class="paragraph">
<p>It is important to note that running out of <code>retries</code> does not cause an
<code>'error&#8217; event or thrown exception. Due to cueball&#8217;s "monitor" behaviour, there
is no real limit generally on the total number of times it will attempt to
connect to a given backend. The `retries</code> value is used to know when to stop
increasing backoff exponentially, when to declare a backend "dead", and when to
declare a pool "failed", but none of these will cause cueball to stop attempts
to reconnect to the backend unless you act to change it. The
<a href="./internals.html">Cueball internals</a> document explains this in more detail.</p>
</div>
<div class="paragraph">
<p>The possible fields in one operation are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>retries</code>&#8201;&#8212;&#8201;finite Number &gt;= 0, number of retry attempts</p>
</li>
<li>
<p><code>timeout</code>&#8201;&#8212;&#8201;finite Number &gt; 0, milliseconds to wait before declaring an
attempt a failure</p>
</li>
<li>
<p><code>maxTimeout</code>&#8201;&#8212;&#8201;Number &gt; <code>timeout</code> (can be <code>Infinity</code>), maximum value of
<code>timeout</code> to be reached with exponential timeout increase</p>
</li>
<li>
<p><code>delay</code>&#8201;&#8212;&#8201;finite Number &gt;= 0, milliseconds to delay between retry attempts</p>
</li>
<li>
<p><code>maxDelay</code>&#8201;&#8212;&#8201;Number &gt; <code>delay</code> (can be <code>Infinity</code>), maximum value of <code>delay</code>
to be reached with exponential delay increase</p>
</li>
<li>
<p><code>delaySpread</code>&#8201;&#8212;&#8201;finite Number between <code>0.0</code> and <code>1.0</code>, the fraction of
the current <code>delay</code> value that should be randomly varied. If not given,
defaults to <code>0.2</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>And the available operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>dns</code>&#8201;&#8212;&#8201;all DNS-related operations, lookups etc</p>
</li>
<li>
<p><code>dns_srv</code>&#8201;&#8212;&#8201;specifically lookups on SRV records, this is separate in case
you need to deal with certain old buggy DNS servers that have trouble with
SRV)</p>
</li>
<li>
<p><code>connect</code>&#8201;&#8212;&#8201;connections to backends in a <code>ConnectionPool</code></p>
</li>
<li>
<p><code>initial</code>&#8201;&#8212;&#8201;the very first attempt to connect to a new backend, will fall
back to <code>connect</code> if not given</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If a given operation has no specification given, it will use <code>default</code> instead.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="dynamic_resolver_mode">11. Dynamic Resolver mode</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>Resolver</code> instances can operate in a so-called "Dynamic Resolver" mode, where
as well as tracking their particular target service in DNS, they also track the
correct nameservers to ask about it.</p>
</div>
<div class="paragraph">
<p>This is useful in systems where the nameservers are listed in DNS as a service
just like your ordinary target service (e.g. HTTP). An example is the Joyent
SDC <code>binder</code>. <code>binder</code> acts as a DNS server, listing addresses of all SDC
service instances. This includes listing its own address, and if multiple
`binder`s are deployed, all other `binder`s in the DC.</p>
</div>
<div class="paragraph">
<p>We can look up the list of currently available <code>binder</code> instances in DNS, and
use this to perform our name resolution. We can also then use the <code>binder`s to
update our original list of `binder</code> instances.</p>
</div>
<div class="paragraph">
<p>This mode requires a "bootstrap" to begin with, however&#8201;&#8212;&#8201;we cannot resolve
the name that the <code>binder</code> instances are listed under until we already know the
address of one of the <code>binder`s. In Dynamic Resolver mode, `cueball</code> will
bootstrap using the system resolvers from <code>/etc/resolv.conf</code>.</p>
</div>
<div class="sect2">
<h3 id="example">11.1. Example</h3>
<div class="listingblock">
<div class="title">Example: Using dynamic resolver mode</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span></span><span class="tok-kr">const</span> <span class="tok-nx">mod_cueball</span> <span class="tok-o">=</span> <span class="tok-nx">require</span><span class="tok-p">(</span><span class="tok-s1">&#39;cueball&#39;</span><span class="tok-p">);</span>
<span class="tok-kr">const</span> <span class="tok-nx">mod_restify</span> <span class="tok-o">=</span> <span class="tok-nx">require</span><span class="tok-p">(</span><span class="tok-s1">&#39;restify-clients&#39;</span><span class="tok-p">);</span>

<span class="tok-kd">var</span> <span class="tok-nx">client</span> <span class="tok-o">=</span> <span class="tok-nx">mod_restify</span><span class="tok-p">.</span><span class="tok-nx">createJsonClient</span><span class="tok-p">({</span>
    <span class="tok-nx">url</span><span class="tok-o">:</span> <span class="tok-s1">&#39;http://napi.coal.joyent.us&#39;</span><span class="tok-p">,</span>
    <span class="tok-nx">agent</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nx">mod_cueball</span><span class="tok-p">.</span><span class="tok-nx">HttpAgent</span><span class="tok-p">({</span>
        <span class="tok-nx">resolvers</span><span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-s1">&#39;binder.coal.joyent.us&#39;</span><span class="tok-p">],</span>
        <span class="tok-nx">spares</span><span class="tok-o">:</span> <span class="tok-mi">4</span><span class="tok-p">,</span> <span class="tok-nx">maximum</span><span class="tok-o">:</span> <span class="tok-mi">8</span>
    <span class="tok-p">})</span>
<span class="tok-p">});</span>

<span class="tok-nx">client</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s1">&#39;/networks/&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">uuid</span><span class="tok-p">,</span> <span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">err</span><span class="tok-p">,</span> <span class="tok-nx">req</span><span class="tok-p">,</span> <span class="tok-nx">res</span><span class="tok-p">,</span> <span class="tok-nx">data</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-p">...</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This example code will start by using the system resolvers to resolve
<code>binder.coal.joyent.us</code>. Then, the records found via this lookup will be used
as nameservers to look up <code>napi.coal.joyent.us</code>.</p>
</div>
<div class="paragraph">
<p>When the TTL expires on the records for <code>binder.coal.joyent.us</code>, we will use
the records from the previous lookup as the list of nameservers to query in
order to find out what the new records should be. Then, we will use any new
nameservers we find for the next <code>napi.coal.joyent.us</code> lookup as well.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="connectionset">12. ConnectionSet</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cueball also includes an alternative to the ConnectionPool, named ConnectionSet.
This is a more low-level API which is useful for implementing clients for
protocols that are not as strictly connection-oriented.</p>
</div>
<div class="paragraph">
<p>Key differences to ConnectionPool:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each backend in a ConnectionSet has a maximum of 1 connection open to it
(it&#8217;s expected to be used with protocols that multiplex operations over a
single socket.)</p>
</li>
<li>
<p>No support for leases (claim/release). ConnectionSet does not track whether
connections are busy or not, and expects its consumer to manage this.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that neither ConnectionSet nor ConnectionPool are suited or designed for
use with sets of distinct backends that are not for a single logical service.
All of the backends returned by your resolver should always be equivalent and
interchangeable, no matter which interface you use.</p>
</div>
<div class="paragraph">
<p>The only reason you should be using a ConnectionSet is if you really wanted a
ConnectionPool, but your service multiplexes operations over a single socket
or isn&#8217;t strictly connection-oriented.</p>
</div>
<div class="paragraph">
<p>ConnectionSets have an identical state graph to ConnectionPools.</p>
</div>
<div class="sect2">
<h3 id="new_connectionsetoptions">12.1. <code>new ConnectionSet(options)</code></h3>
<div class="paragraph">
<p>Parameters</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>options</code>&#8201;&#8212;&#8201;Object, with keys:</p>
<div class="ulist">
<ul>
<li>
<p><code>resolver</code>&#8201;&#8212;&#8201;Object, an instance of the Resolver interface</p>
</li>
<li>
<p><code>constructor</code>&#8201;&#8212;&#8201;Function, same as in ConnectionPool</p>
</li>
<li>
<p><code>recovery</code>&#8201;&#8212;&#8201;Object, a recovery spec (see below)</p>
</li>
<li>
<p><code>target</code>&#8201;&#8212;&#8201;Number, target number of connections to be made
available in the entire set</p>
</li>
<li>
<p><code>maximum</code>&#8201;&#8212;&#8201;Number, maximum number of sockets opened by the set.
Note that this number may temporarily be exceeded by 1 socket
to allow the set to re-balance.</p>
</li>
<li>
<p><code>decoherenceInterval</code>&#8201;&#8212;&#8201;optional Number, seconds between re-shuffles of
the backend preference list to try to avoid "coherence" between multiple
clients (see the Cueball Internals document for more information). Minimum
value of 60 (smaller values will be clamped to 60 seconds).</p>
</li>
<li>
<p><code>log</code>&#8201;&#8212;&#8201;optional Object, a <code>bunyan</code>-style logger to use</p>
</li>
<li>
<p><code>connectionHandlesError</code>&#8201;&#8212;&#8201;optional Boolean (default <code>false</code>). If <code>true</code>,
cueball assumes that the connection object (the
instance returned from <code>constructor</code>) handles
<code>"error"</code> events internally and the emission of
this event is for cueball&#8217;s information only.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="addedkey_connection_handle">12.2. <code>&#8594;added(key, connection, handle)</code></h3>
<div class="paragraph">
<p>Emitted when a new connection becomes available in the set. This event <strong>must</strong>
have a handler on it at all times.</p>
</div>
<div class="paragraph">
<p>The <code>handle</code> that is given as the third argument to this event has two methods
<code>.release()</code> and <code>.close()</code>, like a Pool handle. As with Pool handles, the
<code>.close()</code> method can be used to indicate an otherwise undetectable failure of a
connection (e.g. due to a protocol error making safe use of the connection
impossible) at any time, but unlike a Pool handle, it is an error to call
<code>.release()</code> until after a <code>'removed'</code> event has been emitted.</p>
</div>
<div class="paragraph">
<p>The user of the ConnectionSet should store both the <code>connection</code> and <code>handle</code>
in such a way as to be able to retrieve them using the <code>key</code> (so they can
handle any related <code>'removed'</code> event later).</p>
</div>
<div class="paragraph">
<p>If the <code>.close()</code> method is called on a Set handle, no <code>'removed'</code> event will
be emitted about this connection. It is the caller&#8217;s responsibility to clean
up any remaining state on its side.</p>
</div>
<div class="paragraph">
<p>Parameters</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>key</code>&#8201;&#8212;&#8201;String, a unique key to identify this connection</p>
</li>
<li>
<p><code>connection</code>&#8201;&#8212;&#8201;Object, the connection as returned by the constructor</p>
</li>
<li>
<p><code>handle</code>&#8201;&#8212;&#8201;Object, a handle to be used in response to a 'removed' event
about this connection</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Failing to add a handler to this event <strong>will</strong> cause your program to
crash.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="removedkey_2">12.3. <code>&#8594;removed(key)</code></h3>
<div class="paragraph">
<p>Emitted when an existing connection should be removed from the pool. This event
<strong>must</strong> have a handler on it at all times. The handler is obligated to take all
necessary actions to drain the connection of outstanding requests and then
call the <code>.release()</code> method on the relevant handle.</p>
</div>
<div class="paragraph">
<p>Parameters</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>key</code>&#8201;&#8212;&#8201;String, a unique key to identify the connection</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Failing to add a handler to this event <strong>will</strong> cause your program to
crash.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="stop_3">12.4. <code>#stop()</code></h3>
<div class="paragraph">
<p>Stops the ConnectionSet, disconnecting all available connections (by first
emitting <code>'removed'</code> for them.)</p>
</div>
</div>
<div class="sect2">
<h3 id="settargettarget">12.5. <code>#setTarget(target)</code></h3>
<div class="paragraph">
<p>Sets the target number of connections in the ConnectionSet. Will trigger an
async operation to add or remove connections in order to meet the new target.</p>
</div>
<div class="paragraph">
<p>Parameters</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>target</code>&#8201;&#8212;&#8201;Number</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="getconnections">12.6. <code>#getConnections()</code></h3>
<div class="paragraph">
<p>Returns all the currently open connections in the Set, as an Array.</p>
</div>
</div>
<div class="sect2">
<h3 id="getlasterror_3">12.7. <code>#getLastError()</code></h3>
<div class="paragraph">
<p>When the set has entered state "failed", this method may be used to retrieve
the last Error object emitted by a connection attempt for the set. Note that
while this is very likely to be a proximate cause of the failure,
determining the root cause may require further analysis.</p>
</div>
<div class="paragraph">
<p>Returns an Error object.</p>
</div>
</div>
</div>
</div>
<h1 id="tools" class="sect0">Tools</h1>
<div class="sect1">
<h2 id="cbresolve">13. cbresolve</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>cbresolve</code> tool is provided to show how cueball would resolve a given
configuration.  The output format is not committed.  It may change in the
future.</p>
</div>
<div class="listingblock">
<div class="title">"Example: " 2. Commandline help for the <code>cbresolve</code> command</div>
<div class="content">
<pre>usage: cbresolve HOSTNAME[:PORT]                # for DNS-based lookup
       cbresolve -S | --static IP[:PORT]...     # for static IPs
Locate services in DNS using Cueball resolver.

The following options are available for DNS-based lookups:

    -f, --follow                periodically re-resolve and report changes
    -p, --port PORT             default backend port
    -r, --resolvers IP[,IP...]  list of DNS resolvers
    -s, --service SERVICE       "service" name (for SRV)
    -t, --timeout TIMEOUT       timeout for lookups</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example: Using <code>cbresolve</code> to resolve the DNS name <code>1.moray.us-east.joyent.us</code></div>
<div class="content">
<pre>$ cbresolve 1.moray.emy-10.joyent.us
domain: 1.moray.emy-10.joyent.us
timeout: 5000 milliseconds
172.27.10.218       80 lLbminikNKjfy+iwDobYBuod7Hs=
172.27.10.219       80 iJMaVRehJ2zKfiS55H/lUUFPb9o=</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example: Using <code>cbresolve</code> to resolve IP/port "127.0.0.1:2020"</div>
<div class="content">
<pre>$ cbresolve --static 127.0.0.1:2020
using static IP resolver
127.0.0.1         2020 xBut/f1D52k1TpDN/miW82qXw6k=</pre>
</div>
</div>
<div id="watch-example" class="listingblock">
<div class="title">Example: Using <code>cbresolve</code> to resolve a name and watch for changes</div>
<div class="content">
<pre>$ cbresolve --follow 1.moray.emy-10.joyent.us
domain: 1.moray.emy-10.joyent.us
timeout: 5000 milliseconds
2016-06-23T00:45:00.312Z added      172.27.10.218:80    (lLbminikNKjfy+iwDobYBuod7Hs=)
2016-06-23T00:45:00.314Z added      172.27.10.219:80    (iJMaVRehJ2zKfiS55H/lUUFPb9o=)
2016-06-23T00:49:00.478Z removed    172.27.10.218:80    (lLbminikNKjfy+iwDobYBuod7Hs=)</pre>
</div>
</div>
<div class="paragraph">
<p>In the <a href="#watch-example">last example</a>, one of the DNS entries was removed a few
minutes after the program was started.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-06-26 14:30:53 -0700
</div>
</div>
<style>
pre.pygments .hll { background-color: #ffffcc }
pre.pygments  { background: #f8f8f8; }
pre.pygments .tok-c { color: #408080; font-style: italic } /* Comment */
pre.pygments .tok-err { border: 1px solid #FF0000 } /* Error */
pre.pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #666666 } /* Operator */
pre.pygments .tok-ch { color: #408080; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gr { color: #FF0000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
pre.pygments .tok-go { color: #888888 } /* Generic.Output */
pre.pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
pre.pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #B00040 } /* Keyword.Type */
pre.pygments .tok-m { color: #666666 } /* Literal.Number */
pre.pygments .tok-s { color: #BA2121 } /* Literal.String */
pre.pygments .tok-na { color: #7D9029 } /* Name.Attribute */
pre.pygments .tok-nb { color: #008000 } /* Name.Builtin */
pre.pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #880000 } /* Name.Constant */
pre.pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
pre.pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
pre.pygments .tok-nf { color: #0000FF } /* Name.Function */
pre.pygments .tok-nl { color: #A0A000 } /* Name.Label */
pre.pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #19177C } /* Name.Variable */
pre.pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
pre.pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #008000 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</body>
</html>